name: CI/CD Pipeline Despliegue de 3 Capas

# Eventos que disparan el pipeline
on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecuci√≥n manual

# 1. Variables de Entorno (Basadas en las IPs que obtuviste)
env:
  SSH_USER: ${{ vars.SSH_USER }}
  FRONTEND_HOST: ${{ vars.FRONTEND_HOST }} # 192.168.1.236
  BACKEND_HOST: ${{ vars.BACKEND_HOST }}   # 192.168.1.237
  DB_HOST: ${{ vars.DB_HOST }}             # 192.168.1.238
  DB_USER: ${{ vars.DB_USER }}
  DB_PASS: ${{ secrets.DB_PASS }}          # Contrase√±a de la BD (debe ser un Secret)

# 2. Job de Despliegue
jobs:
  deploy:
    # Ejecuta en tu Runner autohospedado 'yostor1deployer'
    runs-on: self-hosted

    steps:
    - name: ‚öôÔ∏è Checkout del C√≥digo
      uses: actions/checkout@v4

    # 3. Despliegue de la Base de Datos (DB_HOST)
    - name: üíæ Despliegue de la Base de Datos
      run: |
        echo "Copiando esquema SQL y reiniciando en ${DB_HOST}"
        
        # OMITIR VERIFICACI√ìN DE CLAVE DEL HOST (StrictHostKeyChecking=no)
        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${DB_HOST} "mkdir -p /home/${SSH_USER}/app"
        scp -o StrictHostKeyChecking=no ./database/schema.sql ${SSH_USER}@${DB_HOST}:/home/${SSH_USER}/app/schema.sql
        
        # OMITIR VERIFICACI√ìN DE CLAVE DEL HOST (StrictHostKeyChecking=no)
        # Ejecuta la carga del esquema SQL. Cambia 'myapp_db' si tu base de datos tiene otro nombre.
        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${DB_HOST} "
          psql -h 127.0.0.1 -U ${DB_USER} -d myapp_db -f /home/${SSH_USER}/app/schema.sql
        "

    # 4. Despliegue del Backend (BACKEND_HOST)
    - name: üíª Despliegue del Backend (API Node.js)
      run: |
        echo "Desplegando Backend en ${BACKEND_HOST}"
        
        # OMITIR VERIFICACI√ìN DE CLAVE DEL HOST (StrictHostKeyChecking=no)
        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${BACKEND_HOST} "mkdir -p /home/${SSH_USER}/app/backend"
        scp -r -o StrictHostKeyChecking=no ./backend/* ${SSH_USER}@${BACKEND_HOST}:/home/${SSH_USER}/app/backend/
        
        # OMITIR VERIFICACI√ìN DE CLAVE DEL HOST (StrictHostKeyChecking=no)
        # Comandos remotos en el Backend
        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${BACKEND_HOST} "
          # 1. Instalar dependencias
          cd /home/${SSH_USER}/app/backend/
          npm install

          # 2. Crear variables de entorno para el proceso Node
          echo \"DB_HOST=${DB_HOST}\" > .env
          echo \"DB_USER=${DB_USER}\" >> .env
          echo \"DB_PASS=${DB_PASS}\" >> .env
          
          # 3. Reiniciar el proceso PM2 (Asume PM2 ya instalado globalmente)
          pm2 restart backend || pm2 start server.js --name backend --time
        "

    # 5. Despliegue del Frontend (FRONTEND_HOST)
    - name: üåê Despliegue del Frontend (Nginx)
      run: |
        echo "Desplegando Frontend en ${FRONTEND_HOST}"
        
        # OMITIR VERIFICACI√ìN DE CLAVE DEL HOST (StrictHostKeyChecking=no)
        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${FRONTEND_HOST} "mkdir -p /home/${SSH_USER}/app/frontend"
        scp -r -o StrictHostKeyChecking=no ./frontend/* ${SSH_USER}@${FRONTEND_HOST}:/home/${SSH_USER}/app/frontend/
        
        # OMITIR VERIFICACI√ìN DE CLAVE DEL HOST (StrictHostKeyChecking=no)
        # Comandos remotos en el Frontend
        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${FRONTEND_HOST} "
          # Copia archivos a la ruta de Nginx
          sudo cp -r /home/${SSH_USER}/app/frontend/* /var/www/html/

          # Reinicia Nginx
          sudo systemctl restart nginx
        "
