name: CI/CD Pipeline Despliegue de 3 Capas

# Eventos que disparan el pipeline
on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecuci칩n manual

# 1. Variables de Entorno (Basadas en las IPs que obtuviste)
env:
  SSH_USER: ${{ vars.SSH_USER }}
  FRONTEND_HOST: ${{ vars.FRONTEND_HOST }} # 192.168.1.236
  BACKEND_HOST: ${{ vars.BACKEND_HOST }}   # 192.168.1.237
  DB_HOST: ${{ vars.DB_HOST }}             # 192.168.1.238
  DB_USER: ${{ vars.DB_USER }}
  DB_PASS: ${{ secrets.DB_PASS }}          # Contrase침a de la BD (debe ser un Secret)

# 2. Job de Despliegue
jobs:
  deploy:
    # Ejecuta en tu Runner autohospedado
    runs-on: self-hosted

    steps:
    - name: 丘뙖잺 Checkout del C칩digo
      uses: actions/checkout@v4

    # 3. Despliegue de la Base de Datos (DB_HOST)
    - name: 游 Despliegue de la Base de Datos
      shell: bash 
      run: |
        if [ -z "${DB_HOST}" ]; then echo "Error: La variable DB_HOST est치 vac칤a."; exit 1; fi
        SCHEMA_PATH="./database/schema.sql"
        if [ ! -f "$SCHEMA_PATH" ]; then echo "Error: Archivo no encontrado en: $SCHEMA_PATH"; exit 1; fi
        
        echo "Copiando esquema SQL y reiniciando en ${DB_HOST}"
        
        # 1. Crear directorio remoto
        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${DB_HOST} "mkdir -p /home/${SSH_USER}/app"
        
        # 2. Copiar archivo SQL
        scp -o StrictHostKeyChecking=no "$SCHEMA_PATH" ${SSH_USER}@${DB_HOST}:/home/${SSH_USER}/app/schema.sql
        
        # 3. Ejecutar carga del esquema: Inyectamos PGPASSWORD
        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${DB_HOST} "
          export PGPASSWORD='${DB_PASS}'; 
          psql -h 127.0.0.1 -U ${DB_USER} -d myapp_db -f /home/${SSH_USER}/app/schema.sql
        "

    # 4. Despliegue del Backend (BACKEND_HOST)
    - name: 游눹 Despliegue del Backend (API Node.js)
      shell: bash 
      run: |
        echo "Desplegando Backend en ${BACKEND_HOST}"
        
        # 1. Crear contenido de package.json localmente para evitar error EJSONPARSE
        echo '{
          "name": "backend",
          "version": "1.0.0",
          "description": "API Gateway",
          "main": "server.js",
          "dependencies": {
            "express": "^4.18.2",
            "pg": "^8.11.3"
          }
        }' > backend/package.json
        
        # 2. Copiar archivos (scp)
        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${BACKEND_HOST} "mkdir -p /home/${SSH_USER}/app/backend"
        scp -r -o StrictHostKeyChecking=no ./backend/* ${SSH_USER}@${BACKEND_HOST}:/home/${SSH_USER}/app/backend/
        
        # 3. Comandos remotos en el Backend
        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${BACKEND_HOST} "
          # Instalar dependencias
          cd /home/${SSH_USER}/app/backend/
          npm install --legacy-peer-deps
          
          # Crear variables de entorno
          echo \"DB_HOST=${DB_HOST}\" > .env
          echo \"DB_USER=${DB_USER}\" >> .env
          echo \"DB_PASS=${DB_PASS}\" >> .env
          
          # Reiniciar el proceso PM2
          pm2 restart backend || pm2 start server.js --name backend --time
        "

    # 5. Despliegue del Frontend (FRONTEND_HOST)
    - name: 游깷 Despliegue del Frontend (Nginx)
      shell: bash 
      run: |
        echo "Desplegando Frontend en ${FRONTEND_HOST}"
        
        # 1. Copiar archivos (scp)
        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${FRONTEND_HOST} "mkdir -p /home/${SSH_USER}/app/frontend"
        scp -r -o StrictHostKeyChecking=no ./frontend/* ${SSH_USER}@${FRONTEND_HOST}:/home/${SSH_USER}/app/frontend/
        
        # 2. Comandos remotos en el Frontend
        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${FRONTEND_HOST} "
          # Copia archivos a la ruta de Nginx (Funciona por el chown que hicimos)
          cp -r /home/${SSH_USER}/app/frontend/* /var/www/html/

          # Reinicia Nginx (Funciona por la regla NOPASSWD)
          sudo systemctl restart nginx.service
        "
